<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dataset Manager - Pechay Detection System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f8f4; }
    .sidebar { 
      position: fixed; 
      left: 0; 
      top: 0; 
      width: 220px; 
      height: 100%; 
      background: linear-gradient(135deg, #052e16, #064e3b, #022c22);
      background: 
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.15), transparent 60%),
        radial-gradient(circle at bottom right, rgba(22, 163, 74, 0.2), transparent 55%),
        linear-gradient(135deg, #052e16, #064e3b, #022c22);
      color: #f0fff4; 
      padding-top: 20px; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar h2 { text-align: center; margin-bottom: 30px; font-size: 20px; }
    .sidebar .logo {
      display: block;
      width: 80%;
      max-width: 150px;
      height: auto;
      margin: 0 auto 30px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    .sidebar a { 
      display: block; 
      color: #f0fff4; 
      padding: 12px 20px; 
      text-decoration: none; 
      font-size: 16px; 
      transition: all 0.3s ease;
      border-radius: 8px;
      margin: 5px 10px;
    }
    .sidebar a:hover { 
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding-left: 25px; 
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .sidebar a.active { 
      background: rgba(34, 197, 94, 0.25);
      backdrop-filter: blur(10px);
      color: #22c55e;
      font-weight: bold;
      border-left: 3px solid #22c55e;
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
    }
    .main { margin-left: 220px; }
    .header { 
      background: linear-gradient(135deg, rgba(5, 46, 22, 0.9), rgba(6, 78, 59, 0.9));
      backdrop-filter: blur(10px);
      color: #f0fff4; 
      padding: 15px 25px; 
      font-size: 20px; 
      font-weight: bold; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .content { padding: 30px; }
    .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h1 { color: #2e7d32; margin-bottom: 10px; }
    h3 { color: #2e7d32; margin-top: 0; }
    p { color: #555; margin-bottom: 15px; }
    button { background: #2e7d32; color: white; padding: 14px 28px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    button:hover { background: #1b5e20; transform: scale(1.05); }
    .workflow-step {
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #e0e0e0;
    }
    .workflow-step h4 {
        margin-top: 0;
        color: #1b5e20;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
    }
    .step-number {
        background: #1b5e20;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: bold;
    }
    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 15px;
    }
    .radio-option {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 15px 20px;
        background: white;
        border: 2px solid #2e7d32;
        border-radius: 8px;
        transition: all 0.2s;
        flex: 1;
    }
    .radio-option:hover {
        background: #f0f8f0;
        border-color: #1b5e20;
    }
    .radio-option input[type="radio"] {
        accent-color: #2e7d32;
        transform: scale(1.3);
    }
    .upload-area {
        border: 3px dashed #2e7d32;
        padding: 30px;
        text-align: center;
        border-radius: 12px;
        cursor: pointer;
        background: #f8f9fa;
        transition: all 0.3s;
    }
    .upload-area:hover {
        background: #f0f8f0;
        border-color: #1b5e20;
    }
    select, input[type="text"], input[type="file"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #2e7d32;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 15px;
    }
    select:focus, input[type="text"]:focus {
        outline: none;
        border-color: #1b5e20;
        box-shadow: 0 0 0 3px rgba(46,125,50,0.1);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    th {
        background: #f8f9fa;
        color: #2e7d32;
        font-weight: 600;
    }
    tr:hover {
        background: #f8f9fa;
    }
    .status-message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    @media (max-width: 768px) {
        .main { margin-left: 0; }
        .sidebar { width: 100%; height: auto; position: relative; }
        .content { padding: 15px; }
        .radio-group { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Pechay System Logo" class="logo">
    <a href="{{ url_for('dashboard', page='dashboard') }}">üìä Dashboard</a>
    <a href="{{ url_for('dataset_manager') }}" class="active">‚ûï Create Dataset</a>
    <a href="{{ url_for('dashboard', page='upload') }}">üì∏ Scan Leaf</a>
    <a href="{{ url_for('dashboard', page='results') }}">üìù Results</a>
    <a href="{{ url_for('dashboard', page='analytics') }}">üìà Analytics</a>
    <a href="{{ url_for('dashboard', page='settings') }}">‚öôÔ∏è Settings</a>
    <a href="{{ url_for('logout') }}">üö™ Logout</a>
  </div>

  <div class="main">
    <div class="header">Dataset Manager - Pechay Detection System</div>
    <div class="content">
      
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for m in messages %}
            <div class="status-message">{{ m }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
        
        <!-- Workflow Section -->
        <div class="card">
            <h1>‚ûï Create / Update Dataset</h1>
            <p>Follow the workflow below to add images to your Petchay dataset.</p>
            
            <!-- Main Button -->
            <button id="main-create-btn" style="width: 100%; font-size: 1.2rem; padding: 18px; background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); margin-bottom: 20px;" onclick="toggleWorkflow()">
                <i class="fas fa-plus-circle"></i> ‚ûï Create / Update Dataset
            </button>

            <div id="dataset-workflow" style="display: none;">
                <form action="/upload_dataset_workflow" method="post" enctype="multipart/form-data" id="datasetForm" onsubmit="return handleFormSubmit(event)">
                    
                    <!-- Step 1: Select Condition -->
                    <div class="workflow-step">
                        <h4><span class="step-number">1Ô∏è‚É£</span> Select Condition</h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="condition" value="Healthy" onchange="handleConditionChange()" required>
                                <span style="font-weight: 600; color: #2e7d32;">‚óØ Healthy</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="condition" value="Diseased" onchange="handleConditionChange()">
                                <span style="font-weight: 600; color: #dc3545;">‚óØ Diseased</span>
                            </label>
                        </div>
                    </div>

                    <!-- Step 2: Disease Name (Conditional) -->
                    <div id="step-2-diseased" class="workflow-step" style="display: none;">
                        <h4><span class="step-number">2Ô∏è‚É£</span> If Diseased Is Selected</h4>
                        <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">Select Disease Name:</p>
                        <select id="disease_select" name="disease_select" onchange="handleDiseaseSelect()">
                            <option value="" disabled selected>-- Select a disease --</option>
                            <option value="Leaf Spot">Leaf Spot</option>
                            <option value="Downy Mildew">Downy Mildew</option>
                            <option value="Mosaic Virus">Mosaic Virus</option>
                            <option value="Yellowing">Yellowing</option>
                            <option value="new">‚ûï Add New Disease</option>
                        </select>
                        
                        <div id="new-disease-input" style="display: none;">
                            <input type="text" id="new_disease_name" name="new_disease_name" placeholder="Enter new disease name..." oninput="handleDiseaseNameInput()">
                        </div>
                        
                        <!-- Step 2.5: Treatment (Conditional - appears after disease is entered) -->
                        <div id="step-treatment" class="workflow-step" style="display: none; margin-top: 15px; background: #fff3cd; border-color: #ffc107;">
                            <h4 style="color: #856404;"><span class="step-number" style="background: #ffc107; color: #856404;">üíä</span> Treatment</h4>
                            <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">Enter treatment for this disease:</p>
                            <textarea id="treatment" name="treatment" rows="4" placeholder="Enter treatment instructions, remedies, or recommendations for this disease..." style="width: 100%; padding: 12px; border: 2px solid #ffc107; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                            <p style="font-size: 0.85rem; color: #856404; margin-top: 8px; font-style: italic;">
                                <i class="fas fa-info-circle"></i> This treatment will be saved with the disease data and can be used for recommendations.
                            </p>
                        </div>
                    </div>

                    <!-- Step 3: Upload Images -->
                    <div class="workflow-step">
                        <h4><span class="step-number">3Ô∏è‚É£</span> Upload Images</h4>
                        <div class="upload-area" onclick="document.getElementById('dataset_files').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #2e7d32; margin-bottom: 15px;"></i>
                            <p style="margin: 10px 0; font-size: 1.1rem; font-weight: 600; color: #1b5e20;">üì§ Upload Images</p>
                            <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">‚úî Upload multiple images at once</p>
                            <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">‚úî Images save immediately to database</p>
                            <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">‚úî Keep uploading until you click "Complete Upload"</p>
                            <input type="file" id="dataset_files" name="files" multiple accept="image/*" style="display: none;" onchange="handleFileSelectAndUpload(this)">
                            <div id="file-preview" style="font-size: 0.95rem; color: #2e7d32; font-weight: 600; margin-top: 15px;"></div>
                            <div id="upload-status" style="margin-top: 15px;"></div>
                        </div>
                        <div id="uploaded-files-list" style="margin-top: 20px; display: none;">
                            <h5 style="color: #2e7d32; margin-bottom: 10px;">‚úÖ Uploaded Images:</h5>
                            <div id="uploaded-files" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;"></div>
                        </div>
                    </div>

                    <!-- Step 4: Info about Auto Labeling -->
                    <div class="workflow-step" style="background: #e8f5e8; border-color: #2e7d32;">
                        <h4 style="color: #2e7d32;"><span class="step-number" style="background: #2e7d32;">4Ô∏è‚É£</span> Auto Labeling (Behind the Button)</h4>
                        <p style="font-size: 0.9rem; margin: 10px 0; color: #555; line-height: 1.6;">
                            <strong>When uploading:</strong><br>
                            ‚Ä¢ Images are automatically labeled as: <strong>Healthy</strong> or <strong>Diseased ‚Üí Disease Name</strong><br>
                            ‚Ä¢ Labels are prepared for YOLO training<br>
                            ‚Ä¢ Feature embeddings are generated (like face recognition)<br>
                            ‚Ä¢ Data is saved to the database
                        </p>
                    </div>

                    <!-- Step 5: Complete Upload -->
                    <button type="submit" id="complete-upload-btn" style="width: 100%; font-size: 1.2rem; padding: 18px; background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); margin-top: 20px;">
                        <i class="fas fa-check-circle"></i> ‚úÖ Complete Upload & Start Training
                    </button>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 10px; text-align: center;">
                        <strong>What this button does:</strong><br>
                        Triggers YOLO training ‚Ä¢ Generates embeddings ‚Ä¢ Updates dataset ‚Ä¢ Makes data ready for scanning
                    </p>

                </form>
            </div>
        </div>

        <!-- Stats / List -->
        <div class="card">
            <h3><i class="fas fa-list"></i> Custom Training Data</h3>
            <div style="max-height: 500px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Label</th>
                            <th>Added On</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if dataset_images %}
                            {% for img in dataset_images %}
                            <tr>
                                <td>
                                    <img src="{{ img.image_url if img.image_url else url_for('static', filename='Dataset/UserUploads/' + img.label + '/' + img.filename) }}" 
                                         alt="{{ img.label }}" 
                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23eee%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2212%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                                </td>
                                <td>
                                    <span style="background: #e8f5e8; color: #2e7d32; padding: 4px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 600;">
                                        {{ img.label }}
                                    </span>
                                </td>
                                <td style="color: #666; font-size: 0.9rem;">{{ img.created_at[:10] if img.created_at else 'Recent' }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="3" style="text-align: center; color: #666; padding: 40px;">No custom data yet. Start by creating a dataset above!</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
      </div>

    </div>
  </div>

<script>
    function toggleWorkflow() {
        const workflow = document.getElementById('dataset-workflow');
        const btn = document.getElementById('main-create-btn');
        if (workflow.style.display === 'none' || !workflow.style.display) {
            workflow.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Workflow';
            btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
        } else {
            workflow.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-plus-circle"></i> ‚ûï Create / Update Dataset';
            btn.style.background = 'linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%)';
        }
    }

    function handleConditionChange() {
        const condition = document.querySelector('input[name="condition"]:checked');
        if (!condition) return;
        const step2 = document.getElementById('step-2-diseased');
        if (condition.value === 'Diseased') {
            step2.style.display = 'block';
            document.getElementById('disease_select').required = true;
        } else {
            step2.style.display = 'none';
            document.getElementById('disease_select').required = false;
        }
    }

    function handleDiseaseSelect() {
        const select = document.getElementById('disease_select');
        const inputDiv = document.getElementById('new-disease-input');
        const treatmentDiv = document.getElementById('step-treatment');
        
        if (select.value === 'new') {
            inputDiv.style.display = 'block';
            const input = document.getElementById('new_disease_name');
            if (input) input.required = true;
            treatmentDiv.style.display = 'none'; // Hide treatment until disease name is entered
        } else if (select.value && select.value !== '') {
            inputDiv.style.display = 'none';
            const input = document.getElementById('new_disease_name');
            if (input) input.required = false;
            // Show treatment field when disease is selected
            treatmentDiv.style.display = 'block';
        } else {
            inputDiv.style.display = 'none';
            treatmentDiv.style.display = 'none';
        }
    }
    
    function handleDiseaseNameInput() {
        const newDiseaseInput = document.getElementById('new_disease_name');
        const treatmentDiv = document.getElementById('step-treatment');
        const diseaseSelect = document.getElementById('disease_select');
        
        // Show treatment field when disease name is entered (for new diseases)
        if (diseaseSelect.value === 'new' && newDiseaseInput.value.trim() !== '') {
            treatmentDiv.style.display = 'block';
        } else if (diseaseSelect.value === 'new' && newDiseaseInput.value.trim() === '') {
            treatmentDiv.style.display = 'none';
        }
    }

    let uploadedFilesCount = 0;
    const uploadedFilesList = [];

    async function handleFileSelectAndUpload(input) {
        const files = input.files;
        const preview = document.getElementById('file-preview');
        const statusDiv = document.getElementById('upload-status');
        const uploadedListDiv = document.getElementById('uploaded-files-list');
        const uploadedFilesDiv = document.getElementById('uploaded-files');
        
        if (files.length === 0) {
            preview.innerHTML = '';
            return;
        }

        // Get form data
        const condition = document.querySelector('input[name="condition"]:checked')?.value || 'Healthy';
        const diseaseSelect = document.getElementById('disease_select')?.value || '';
        const newDiseaseName = document.getElementById('new_disease_name')?.value || '';
        const treatment = document.getElementById('treatment')?.value || '';
        
        // Show loading state
        preview.innerHTML = `<i class="fas fa-spinner fa-spin" style="color: #2e7d32; margin-right: 8px;"></i> Uploading ${files.length} file(s)...`;
        statusDiv.innerHTML = '';
        
        // Upload each file immediately
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('condition', condition);
            formData.append('disease_select', diseaseSelect);
            if (newDiseaseName) {
                formData.append('new_disease_name', newDiseaseName);
            }
            if (treatment) {
                formData.append('treatment', treatment);
            }
            
            try {
                const response = await fetch('/upload_image_immediate', {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is OK and is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    errorCount++;
                    console.error('Server returned non-JSON response:', text.substring(0, 200));
                    continue;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    successCount++;
                    uploadedFilesCount++;
                    uploadedFilesList.push({
                        filename: result.filename,
                        originalName: file.name
                    });
                    
                    // Update uploaded files list
                    uploadedListDiv.style.display = 'block';
                    uploadedFilesDiv.innerHTML = uploadedFilesList.map((f, idx) => 
                        `<div style="padding: 8px; margin: 5px 0; background: white; border-radius: 5px; border-left: 3px solid #28a745;">
                            <i class="fas fa-check-circle" style="color: #28a745; margin-right: 8px;"></i>
                            <strong>${f.originalName}</strong> <small style="color: #666;">(${f.filename})</small>
                        </div>`
                    ).join('');
                } else {
                    errorCount++;
                    console.error('Upload error:', result.error);
                }
            } catch (error) {
                errorCount++;
                console.error('Upload error:', error);
            }
        }
        
        // Update preview
        if (successCount > 0) {
            preview.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745; margin-right: 8px;"></i> <strong>${successCount}</strong> file(s) uploaded successfully!`;
            if (errorCount > 0) {
                statusDiv.innerHTML = `<div style="color: #dc3545; margin-top: 10px;"><i class="fas fa-exclamation-triangle"></i> ${errorCount} file(s) failed to upload</div>`;
            } else {
                statusDiv.innerHTML = `<div style="color: #28a745; margin-top: 10px;"><i class="fas fa-info-circle"></i> Want to upload more? Click the upload area again!</div>`;
            }
        } else {
            preview.innerHTML = `<i class="fas fa-times-circle" style="color: #dc3545; margin-right: 8px;"></i> Upload failed. Please try again.`;
        }
        
        // Show uploaded files list
        if (uploadedFilesList.length > 0) {
            uploadedListDiv.style.display = 'block';
        }
        
        // Clear input to allow selecting same files again
        input.value = '';
    }

    function handleFormSubmit(event) {
        const btn = document.getElementById('complete-upload-btn');
        const condition = document.querySelector('input[name="condition"]:checked')?.value;
        
        if (!condition) {
            event.preventDefault();
            alert('Please select a condition (Healthy or Diseased)');
            return false;
        }
        
        if (condition === 'Diseased') {
            const diseaseSelect = document.getElementById('disease_select')?.value;
            if (!diseaseSelect || diseaseSelect === '') {
                event.preventDefault();
                alert('Please select or enter a disease name');
                return false;
            }
        }
        
        if (uploadedFilesCount === 0) {
            const confirmUpload = confirm('No images have been uploaded yet. Do you want to continue anyway? (You can upload images later)');
            if (!confirmUpload) {
                event.preventDefault();
                return false;
            }
        }
        
        // Disable button to prevent double submission
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        return true;
    }
</script>

</body>
</html>
