<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pechay Leaf Detection Dashboard</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f8f4; }
    .sidebar { 
      position: fixed; 
      left: 0; 
      top: 0; 
      width: 220px; 
      height: 100%; 
      background: linear-gradient(135deg, #052e16, #064e3b, #022c22);
      background: 
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.15), transparent 60%),
        radial-gradient(circle at bottom right, rgba(22, 163, 74, 0.2), transparent 55%),
        linear-gradient(135deg, #052e16, #064e3b, #022c22);
      color: #f0fff4; 
      padding-top: 20px; 
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar h2 { 
      text-align: center; 
      margin-bottom: 30px; 
      font-size: 20px; 
      color: #f0fff4;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .sidebar .logo {
      display: block;
      width: 80%;
      max-width: 150px;
      height: auto;
      margin: 0 auto 30px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }
    .sidebar a { 
      display: block; 
      color: #f0fff4; 
      padding: 12px 20px; 
      text-decoration: none; 
      font-size: 16px; 
      transition: all 0.3s ease;
      border-radius: 8px;
      margin: 5px 10px;
    }
    .sidebar a:hover { 
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding-left: 25px; 
      transform: translateX(5px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .sidebar a.active { 
      background: rgba(34, 197, 94, 0.25);
      backdrop-filter: blur(10px);
      color: #22c55e;
      font-weight: bold;
      border-left: 3px solid #22c55e;
      box-shadow: 0 4px 10px rgba(34, 197, 94, 0.2);
    }
    .main { margin-left: 220px; }
    .header { 
      background: linear-gradient(135deg, rgba(5, 46, 22, 0.9), rgba(6, 78, 59, 0.9));
      backdrop-filter: blur(10px);
      color: #f0fff4; 
      padding: 15px 25px; 
      font-size: 20px; 
      font-weight: bold; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .content { padding: 30px; display: flex; justify-content: center; align-items: center; min-height: 70vh; }
    .card { 
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 30px; 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      width: 100%; 
      text-align: left;
      margin: 15px auto;
    }
    .card.full-width {
      max-width: 1200px;
    }
    h1 { 
      color: #052e16; 
      margin-bottom: 15px; 
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(255,255,255,0.5);
    }
    p { 
      color: #052e16; 
      margin-bottom: 25px; 
      font-weight: 500;
      opacity: 0.9;
    }
    input[type="file"] { margin: 15px 0; padding: 10px; border: 2px solid #2e7d32; border-radius: 10px; cursor: pointer; width: 100%; }
    button { background: #2e7d32; color: white; padding: 14px 28px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 15px; }
    button:hover { background: #1b5e20; transform: scale(1.05); }
    img.preview { max-width: 100%; border-radius: 12px; margin-top: 20px; display: none; }
    footer { text-align: center; margin: 30px 0 0; padding: 15px; background: #f1f1f1; font-size: 14px; color: #777; }
    .status-message { 
      padding: 12px 18px; 
      margin: 10px 0; 
      border-radius: 12px; 
      background: rgba(34, 197, 94, 0.25);
      backdrop-filter: blur(10px);
      color: #14532d; 
      border: 1px solid rgba(34, 197, 94, 0.4);
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }
    .error-message { 
      background: rgba(220, 53, 69, 0.25);
      backdrop-filter: blur(10px);
      color: #991b1b; 
      border: 1px solid rgba(220, 53, 69, 0.4);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
    }
    .result-card { 
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 16px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-left: 4px solid #2e7d32;
      transition: all 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      background: rgba(255, 255, 255, 0.3);
    }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { 
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(15px) saturate(180%);
      -webkit-backdrop-filter: blur(15px) saturate(180%);
      padding: 25px; 
      border-radius: 16px; 
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
      text-align: center; 
      transition: all 0.3s ease;
    }
    .stat-card.clickable { cursor: pointer; }
    .stat-card.clickable:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 12px 32px rgba(34, 197, 94, 0.2);
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.5);
    }
    .stat-number { 
      font-size: 2.5em; 
      font-weight: bold; 
      color: #052e16;
      text-shadow: 0 2px 4px rgba(255,255,255,0.3);
    }
    .stat-label { 
      color: #052e16; 
      margin-top: 8px; 
      font-weight: 600;
      opacity: 0.8;
    }
    .filter-badge { 
      display: inline-block; 
      background: rgba(34, 197, 94, 0.3);
      backdrop-filter: blur(10px);
      color: #052e16; 
      padding: 8px 18px; 
      border-radius: 20px; 
      margin: 10px 5px; 
      font-size: 0.9rem; 
      border: 1px solid rgba(34, 197, 94, 0.4);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
      font-weight: 600;
    }
    .filter-badge .clear-filter { 
      margin-left: 10px; 
      cursor: pointer; 
      font-weight: bold; 
      padding: 2px 8px;
      border-radius: 12px;
      transition: all 0.2s;
    }
    .filter-badge .clear-filter:hover { 
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    .date-filters {
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      margin: 15px 0; 
      padding: 15px; 
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px; 
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .date-filter-btn {
      padding: 10px 18px; 
      border: 1px solid rgba(34, 197, 94, 0.4); 
      border-radius: 10px; 
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      color: #052e16; 
      cursor: pointer; 
      font-size: 0.9rem; 
      font-weight: 600; 
      transition: all 0.3s; 
      text-decoration: none; 
      display: inline-block;
    }
    .date-filter-btn:hover {
      background: rgba(34, 197, 94, 0.3);
      backdrop-filter: blur(10px);
      color: #14532d; 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      border-color: rgba(34, 197, 94, 0.6);
    }
    .date-filter-btn.active {
      background: rgba(34, 197, 94, 0.4);
      backdrop-filter: blur(10px);
      color: #052e16; 
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }
    .delete-btn { background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
    .delete-btn:hover { background: #c82333; transform: scale(1.05); }
    .result-actions { margin-top: 15px; }
    .recommendations {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-left: 4px solid #28a745; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }
    .recommendations.diseased { border-left-color: #dc3545; }
    .recommendations h4 { color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold; }
    .recommendations.diseased h4 { color: #991b1b; }
    .recommendations ul { margin: 10px 0; padding-left: 20px; }
    .recommendations li { margin: 8px 0; color: #052e16; font-weight: 500; }
    .recommendations .action { 
      background: rgba(34, 197, 94, 0.2);
      backdrop-filter: blur(10px);
      padding: 12px; 
      border-radius: 10px; 
      margin-top: 15px; 
      font-weight: 600; 
      color: #14532d; 
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .recommendations.diseased .action { 
      background: rgba(220, 53, 69, 0.2);
      backdrop-filter: blur(10px);
      color: #991b1b; 
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    .recommendations.urgent { border-left-color: #ff0000; border-left-width: 6px; }
    .recommendations.urgent h4 { color: #991b1b; font-weight: bold; }
    .result-card.healthy { border-left-color: #28a745; }
    .result-card.diseased { border-left-color: #dc3545; }
    .status-healthy { color: #28a745; }
    .status-diseased { color: #dc3545; }
    .disease-name { color: #dc3545; }
    .camera-section {
      background: #fff !important;
      padding: 15px !important;
      border-radius: 12px !important;
      border: 3px solid #2e7d32 !important;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2) !important;
      display: block !important;
      visibility: visible !important;
      margin: 15px auto !important;
      max-width: 1200px !important;
      width: 95% !important;
    }
    .camera-section h2 {
      color: #2e7d32;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
    }
    .camera-controls {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .camera-controls input {
      flex: 2;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #2e7d32;
      border-radius: 8px;
      font-size: 1rem;
    }
    .camera-controls button {
      padding: 12px 20px;
      margin: 0;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .text-healthy { color: #2e7d32; font-size: 0.8rem; font-weight: bold; }
    .text-diseased { color: #dc3545; font-size: 0.8rem; font-weight: bold; }
    .camera-controls button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .stream-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .stream-status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .stream-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #cameraViewContainer {
      position: relative;
      margin-top: 15px;
      background: #000;
      border-radius: 10px;
      min-height: 200px;
      max-height: 350px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #2e7d32;
      overflow: hidden;
      width: 100%;
    }
    #cameraStream {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      border-radius: 8px;
      object-fit: contain;
    }
    .content {
      padding: 20px;
      display: block;
      min-height: auto;
    }
    .card.upload-page {
      max-width: 1200px;
      text-align: left;
      margin: 15px auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }
    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .main {
        margin-left: 0;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Pechay System Logo" class="logo">
    <a href="{{ url_for('dashboard', page='dashboard') }}" class="{{ 'active' if page=='dashboard' else '' }}">üìä Dashboard</a>
    <a href="{{ url_for('dataset_manager') }}" class="{{ 'active' if request.endpoint == 'dataset_manager' else '' }}">‚ûï Create Dataset</a>
    <a href="{{ url_for('dashboard', page='upload') }}" class="{{ 'active' if page=='upload' else '' }}">üì∏ Scan Leaf</a>
    <a href="{{ url_for('dashboard', page='results') }}" class="{{ 'active' if page=='results' else '' }}">üìù Results</a>
    <a href="{{ url_for('dashboard', page='analytics') }}" class="{{ 'active' if page=='analytics' else '' }}">üìà Analytics</a>
    <a href="{{ url_for('dashboard', page='settings') }}" class="{{ 'active' if page=='settings' else '' }}">‚öôÔ∏è Settings</a>
  </div>

  <div class="main">
    <div class="header">Pechay Leaf Detection Dashboard</div>
    <div class="content">
      {% if page == 'dashboard' %}
      <div class="card full-width">
        <h1>üìä Dashboard Overview</h1>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-number">{{ dashboard_stats.total_scans }}</div><div class="stat-label">Total Scans</div></div>
          <div class="stat-card clickable" data-href="{{ url_for('dashboard', page='results', filter='Healthy') }}" onclick="window.location.href=this.dataset.href" title="Click to view Healthy leaves">
            <div class="stat-number">üìÅ {{ dashboard_stats.healthy_leaves }}</div>
            <div class="stat-label">Healthy Leaves</div>
          </div>
          <div class="stat-card clickable" data-href="{{ url_for('dashboard', page='results', filter='Diseased') }}" onclick="window.location.href=this.dataset.href" title="Click to view Diseased leaves">
            <div class="stat-number">üìÅ {{ dashboard_stats.diseased_leaves }}</div>
            <div class="stat-label">Diseased Leaves</div>
          </div>
          <div class="stat-card"><div class="stat-number">{{ dashboard_stats.success_rate }}%</div><div class="stat-label">Success Rate</div></div>
        </div>
        
        {% if dashboard_stats.total_scans == 0 %}
        <div class="status-message" style="background: rgba(34, 197, 94, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(34, 197, 94, 0.4); padding: 20px; border-radius: 12px;">
          <h3 style="color: #052e16; margin-top: 0;">üå± Welcome to Pechay Detection System!</h3>
          <p style="color: #052e16; margin-bottom: 0;">No scans yet. Upload your first pechay leaf image to get started with detection.</p>
        </div>
        {% else %}
        <div class="status-message" style="background: rgba(34, 197, 94, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(34, 197, 94, 0.4); padding: 20px; border-radius: 12px;">
          <h3 style="color: #052e16; margin-top: 0;">üìà Recent Activity</h3>
          <p style="color: #052e16; margin-bottom: 5px;">You have processed <strong>{{ dashboard_stats.total_scans }}</strong> leaf images.</p>
          <p style="color: #052e16; margin-bottom: 0;"><strong>Health Distribution:</strong> {{ "%.0f"|format((dashboard_stats.healthy_leaves / dashboard_stats.total_scans) * 100) }}% healthy, {{ "%.0f"|format((dashboard_stats.diseased_leaves / dashboard_stats.total_scans) * 100) }}% diseased</p>
        </div>
        {% endif %}
        
        <div style="margin-top: 25px;">
          <a href="{{ url_for('dataset_manager') }}" style="display:inline-block;background:#1b5e20;color:white;padding:16px 32px;text-decoration:none;border-radius:12px;margin-right:15px;font-size:1.1rem;font-weight:bold;box-shadow:0 4px 12px rgba(27,94,32,0.3);">
            ‚ûï Create Petchay Dataset
          </a>
          <a href="{{ url_for('dashboard', page='upload') }}" style="display:inline-block;background:#2e7d32;color:white;padding:12px 24px;text-decoration:none;border-radius:8px;margin-right:15px;">üì∑ Upload New Image</a>
          <a href="{{ url_for('dashboard', page='results') }}" style="display:inline-block;background:#388e3c;color:white;padding:12px 24px;text-decoration:none;border-radius:8px;">üìù View Results</a>
        </div>
      </div>
      {% elif page == 'analytics' %}
      <div class="card full-width">
        <h1>üìà Analytics & Reports</h1>
        
        {% if analytics_data %}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
           <!-- Charts containers -->
           <div style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
             <h3 style="text-align: center; color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold;">Last 7 Days Activity</h3>
             <canvas id="dailyChart" style="max-height: 200px;"></canvas>
           </div>
           <div style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
             <h3 style="text-align: center; color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold;">Health Distribution</h3>
             <div style="height: 200px; display: flex; justify-content: center;">
                <canvas id="pieChart"></canvas>
             </div>
           </div>
        </div>

        <div style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 20px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1); margin-bottom: 30px;">
             <h3 style="text-align: center; color: #052e16; margin-bottom: 15px; font-size: 1.1rem; font-weight: bold;">Confidence Level Distribution</h3>
             <canvas id="confidenceChart" style="max-height: 200px;"></canvas>
        </div>

        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3 style="color: #2e7d32; text-align: center;">üìÑ Generate Report</h3>
            <p style="text-align: center;">Customize and download a printable report of your detection history.</p>
            
            <form action="{{ url_for('report') }}" method="GET" target="_blank" style="max-width: 600px; margin: 0 auto; background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(15px); padding: 25px; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 24px rgba(0,0,0,0.1);">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #052e16;">Condition:</label>
                    <select name="condition" style="width: 100%; padding: 12px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16; font-weight: 500;">
                        <option value="All">All Conditions</option>
                        <option value="Healthy">Healthy Only</option>
                        <option value="Diseased">Diseased Only</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #052e16;">Time Range:</label>
                    <select name="range" id="reportRange" onchange="toggleCustomDates()" style="width: 100%; padding: 12px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16; font-weight: 500;">
                        <option value="all">All Time</option>
                        <option value="day">Last 24 Hours</option>
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                
                <div id="customDates" style="display: none; margin-bottom: 15px; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5);">
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #052e16; font-weight: 600;">Start Date:</label>
                        <input type="date" name="start_date" style="width: 100%; padding: 10px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #052e16; font-weight: 600;">End Date:</label>
                        <input type="date" name="end_date" style="width: 100%; padding: 10px; border: 1px solid rgba(5, 46, 22, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); color: #052e16;">
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button type="submit" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #052e16; padding: 14px 28px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: all 0.3s;">
                        <span>üñ®Ô∏è</span> Generate & View Report
                    </button>
                </div>
            </form>
            
            <script>
                function toggleCustomDates() {
                    var range = document.getElementById('reportRange').value;
                    var customDates = document.getElementById('customDates');
                    if (range === 'custom') {
                        customDates.style.display = 'block';
                    } else {
                        customDates.style.display = 'none';
                    }
                }
            </script>
        </div>
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <!-- Data for charts -->
        <script type="application/json" id="daily-labels">{{ analytics_data.daily_labels | tojson | safe }}</script>
        <script type="application/json" id="daily-values">{{ analytics_data.daily_values | tojson | safe }}</script>
        <script type="application/json" id="confidence-labels">{{ analytics_data.confidence_labels | tojson | safe }}</script>
        <script type="application/json" id="confidence-values">{{ analytics_data.confidence_values | tojson | safe }}</script>
        
        <script>
            // Parse data from hidden script tags to avoid linter errors with Jinja syntax
            const dailyLabels = JSON.parse(document.getElementById('daily-labels').textContent);
            const dailyValues = JSON.parse(document.getElementById('daily-values').textContent);
            const confidenceLabels = JSON.parse(document.getElementById('confidence-labels').textContent);
            const confidenceValues = JSON.parse(document.getElementById('confidence-values').textContent);
            const healthyCount = Number('{{ analytics_data.healthy_count }}');
            const diseasedCount = Number('{{ analytics_data.diseased_count }}');

            // Daily Chart
            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Scans',
                        data: dailyValues,
                        backgroundColor: '#2e7d32',
                        borderRadius: 4
                    }]
                },
                options: { 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });

            // Pie Chart
            new Chart(document.getElementById('pieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Healthy', 'Diseased'],
                    datasets: [{
                        data: [healthyCount, diseasedCount],
                        backgroundColor: ['#4caf50', '#f44336']
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Confidence Chart
            new Chart(document.getElementById('confidenceChart'), {
                type: 'bar',
                data: {
                    labels: confidenceLabels,
                    datasets: [{
                        label: 'Count',
                        data: confidenceValues,
                        backgroundColor: '#1976d2',
                        borderRadius: 4
                    }]
                },
                options: { 
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                    plugins: { legend: { display: false } }
                }
            });
        </script>
        {% else %}
        <div class="status-message error-message" style="background: rgba(220, 53, 69, 0.25); backdrop-filter: blur(10px); border: 1px solid rgba(220, 53, 69, 0.4); color: #991b1b; font-weight: 600;">
            Failed to load analytics data. Please try again.
        </div>
        {% endif %}
      </div>
      {% elif page == 'upload' %}
      <!-- ESP32-CAM Live Stream Section - MUST BE VISIBLE -->
      <div class="camera-section" id="esp32CameraSection">
        <h2>üìπ ESP32-CAM Live View</h2>
        <p style="color: #666; margin-bottom: 15px; text-align: center; font-size: 1rem;">Connect to your ESP32-CAM to view live feed</p>
        <div id="streamStatus" class="stream-status">
          Enter ESP32-CAM IP address and click "Start Stream" or "Start Polling"
        </div>
        <div class="camera-controls">
          <input type="text" id="cameraIP" placeholder="ESP32-CAM IP (e.g., 192.168.1.100)" value="" onkeypress="if(event.key==='Enter') startStream()">
          <button type="button" onclick="startStream()" style="background: #2e7d32;">‚ñ∂Ô∏è Start Stream</button>
          <button type="button" onclick="startPolling()" style="background: #17a2b8;">üîÑ Start Polling</button>
          <button type="button" onclick="stopStream()" style="background: #dc3545;">‚èπÔ∏è Stop</button>
          <button type="button" onclick="testConnection()" style="background: #6c757d;">üîç Test</button>
        </div>
        <div id="cameraViewContainer">
          <img id="cameraStream" src="" alt="Camera stream will appear here" style="display: none;">
          <iframe id="cameraStreamFrame" src="" style="display: none; width: 100%; height: 100%; min-height: 200px; border: none; border-radius: 8px;"></iframe>
          <canvas id="captureCanvas" style="display: none;"></canvas>
          <div id="streamPlaceholder" style="color: #999; text-align: center; padding: 40px; width: 100%;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üì∑</div>
            <div style="font-size: 1.3rem; margin-bottom: 15px; color: #fff;">Camera Live View</div>
            <div style="color: #aaa; margin-bottom: 10px;">Enter ESP32-CAM IP address above</div>
            <small style="color: #888;">Click "Start Polling" or "Start Stream" to begin</small>
          </div>
        </div>
        <div class="camera-controls" style="margin-top: 15px; justify-content: center;">
          <button type="button" onclick="captureFromStream()" id="captureBtn" disabled style="background: #28a745; padding: 12px 30px; font-size: 1rem; font-weight: bold;">üì∏ Capture & Detect Leaf Condition</button>
        </div>
      </div>
      
      <div class="card upload-page" style="margin-top: 30px;">
        <h1>üì∏ Scan Petchay Leaf</h1>
        <p>Upload a pechay leaf image (from ESP32-CAM or computer) to detect disease condition.</p>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for m in messages %}<div class="status-message">{{ m }}</div>{% endfor %}
          {% endif %}
        {% endwith %}
        {% if upload_status %}
        <div class="status-message {{ 'error-message' if 'Error' in upload_status else '' }}">{{ upload_status }}</div>
        {% endif %}
        {% if detection_result %}
        <div class="result-card {{ 'healthy' if detection_result.condition == 'Healthy' else 'diseased' }}" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 5px solid;">
          <h3 class="{{ 'status-healthy' if detection_result.condition == 'Healthy' else 'status-diseased' }}" style="margin-top: 0;">üîç Detection Result</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Status</div>
              <div class="{{ 'status-healthy' if detection_result.condition == 'Healthy' else 'status-diseased' }}" style="font-size: 1.3rem; font-weight: bold;">
                {{ detection_result.condition }}
              </div>
            </div>
            {% if detection_result.disease_name %}
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Disease</div>
              <div class="disease-name" style="font-size: 1.3rem; font-weight: bold; color: #dc3545;">
                {{ detection_result.disease_name }}
              </div>
            </div>
            {% endif %}
            {% if detection_result.treatment %}
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); grid-column: 1 / -1; margin-top: 10px; border-left: 4px solid #ffc107;">
              <div style="font-size: 0.9rem; color: #856404; margin-bottom: 8px; font-weight: 600;">
                <i class="fas fa-prescription-bottle-alt"></i> Treatment
              </div>
              <div style="font-size: 1rem; color: #856404; line-height: 1.6; white-space: pre-wrap;">
                {{ detection_result.treatment }}
              </div>
            </div>
            {% endif %}
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Confidence</div>
              <div style="font-size: 1.3rem; font-weight: bold; color: #2e7d32;">
                {{ "%.0f"|format(detection_result.confidence) }}%
              </div>
            </div>
          </div>
          <img src="/{{ detection_result.image_path }}" style="max-width:300px;border-radius:8px;margin-top:15px;box-shadow: 0 4px 8px rgba(0,0,0,0.2);" />
        </div>
        
        {% if detection_result.recommendations %}
        <div class="recommendations {{ detection_result.condition.lower() }} {% if detection_result.recommendations.urgency == 'high' %}urgent{% endif %}">
          <h4>{{ detection_result.recommendations.title }}</h4>
          <ul>
            {% for tip in detection_result.recommendations.tips %}
            <li>{{ tip }}</li>
            {% endfor %}
          </ul>
          <div class="action">{{ detection_result.recommendations.action }}</div>
        </div>
        {% endif %}
        {% endif %}
        <form method="POST" enctype="multipart/form-data">
          <input type="file" name="leafImage" accept="image/*" required style="margin-bottom: 15px;">
          <br>
          <button type="submit" style="background: #2e7d32; color: white; padding: 16px 40px; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(46,125,50,0.3);">
            üì∏ Scan Petchay Leaf
          </button>
        </form>
      </div>
      {% elif page == 'results' %}
      <div class="card" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
        <h1 style="color: #052e16; text-shadow: 0 2px 4px rgba(255,255,255,0.5);">üìù Detection Results</h1>
        
        <!-- Date Filter Buttons -->
        <div class="date-filters">
          <span style="color: #555; font-weight: 600; margin-right: 10px;">üìÖ Filter by time range:</span>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='') }}" 
             class="date-filter-btn {{ 'active' if not filter_days else '' }}">
            All Time
          </a>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='1') }}" 
             class="date-filter-btn {{ 'active' if filter_days == '1' else '' }}">
            Last 24 Hours
          </a>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='7') }}" 
             class="date-filter-btn {{ 'active' if filter_days == '7' else '' }}">
            Last 7 Days
          </a>
          <a href="{{ url_for('dashboard', page='results', filter=filter_condition, days='21') }}" 
             class="date-filter-btn {{ 'active' if filter_days == '21' else '' }}">
            Last 21 Days
          </a>
        </div>
        
        {% if filter_condition %}
        <div class="filter-badge">
          Showing: <strong>{{ filter_condition }}</strong> leaves only
          <span class="clear-filter" data-href="{{ url_for('dashboard', page='results', days=filter_days) }}" onclick="window.location.href=this.dataset.href">‚úï Clear Filter</span>
        </div>
        {% endif %}
        
        {% if filter_days and date_range_text %}
        <div class="filter-badge" style="background: #17a2b8;">
          Showing results from: <strong>{{ date_range_text }}</strong>
          <span class="clear-filter" data-href="{{ url_for('dashboard', page='results', filter=filter_condition) }}" onclick="window.location.href=this.dataset.href">‚úï Clear</span>
        </div>
        {% endif %}
        
        <p style="color: #052e16; font-weight: 500; margin-bottom: 20px;">Recent leaf detection results and analysis.</p>
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for m in messages %}<div class="status-message">{{ m }}</div>{% endfor %}
          {% endif %}
        {% endwith %}
        {% if results|length == 0 %}
        <div class="status-message">
          {% if filter_condition %}
          No {{ filter_condition.lower() }} leaves found. Try removing the filter or upload new images.
          {% else %}
          No detection results found. Upload some images first!
          {% endif %}
        </div>
        {% else %}
          {% for r in results %}
          <div class="result-card {{ 'healthy' if r.condition == 'Healthy' else 'diseased' }}" style="border-left: 5px solid;">
            <h4 class="{{ 'status-healthy' if r.condition == 'Healthy' else 'status-diseased' }}" style="margin-top: 0;">{{ r.filename }}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 15px 0;">
              <div style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 0.8rem; color: #052e16; margin-bottom: 8px; font-weight: 600; opacity: 0.8;">Status</div>
                <div class="{{ 'status-healthy' if r.condition == 'Healthy' else 'status-diseased' }}" style="font-size: 1.2rem; font-weight: bold;">
                  {{ r.condition }}
                </div>
              </div>
              {% if r.disease_name %}
              <div style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 0.8rem; color: #052e16; margin-bottom: 8px; font-weight: 600; opacity: 0.8;">Disease</div>
                <div class="disease-name" style="font-size: 1.2rem; font-weight: bold; color: #dc3545;">
                  {{ r.disease_name }}
                </div>
              </div>
              {% endif %}
              {% if r.treatment %}
              <div style="background: linear-gradient(135deg, rgba(255, 243, 205, 0.8) 0%, rgba(255, 234, 167, 0.8) 100%); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1); grid-column: 1 / -1; margin-top: 10px; border-left: 4px solid #ffc107;">
                <div style="font-size: 0.8rem; color: #856404; margin-bottom: 8px; font-weight: 600; opacity: 0.9;">
                  <i class="fas fa-prescription-bottle-alt"></i> Treatment
                </div>
                <div style="font-size: 0.95rem; color: #856404; line-height: 1.6; white-space: pre-wrap;">
                  {{ r.treatment }}
                </div>
              </div>
              {% endif %}
              <div style="background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); padding: 15px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 0.8rem; color: #052e16; margin-bottom: 8px; font-weight: 600; opacity: 0.8;">Confidence</div>
                <div style="font-size: 1.2rem; font-weight: bold; color: #14532d;">
                  {{ "%.0f"|format(r.confidence) }}%
                </div>
              </div>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin: 10px 0;"><strong>Date:</strong> {{ r.timestamp }}</p>
            {% if r.filename %}
            <img src="{{ url_for('uploaded_file', filename=r.filename) }}" 
                 alt="{{ r.filename }}" 
                 style="max-width:200px;border-radius:8px;margin-top:10px;display:block;cursor:pointer;"
                 onclick="window.open(this.src, '_blank')"
                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22150%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22200%22 height=%22150%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22sans-serif%22 font-size=%2214%22%3EImage not found%3C/text%3E%3C/svg%3E'; this.style.border='2px dashed #ccc';" />
            {% else %}
            <p style="color:#999;font-style:italic;margin-top:10px;">No image available</p>
            {% endif %}
            
            {% if r.treatment %}
            <div style="background: linear-gradient(135deg, rgba(255, 243, 205, 0.9) 0%, rgba(255, 234, 167, 0.9) 100%); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 193, 7, 0.5); box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 15px; border-left: 5px solid #ffc107;">
              <h4 style="color: #856404; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-prescription-bottle-alt"></i> Treatment Information
              </h4>
              <div style="font-size: 0.95rem; color: #856404; line-height: 1.8; white-space: pre-wrap; background: rgba(255, 255, 255, 0.6); padding: 15px; border-radius: 8px;">
                {{ r.treatment }}
              </div>
            </div>
            {% endif %}
            
            {% if r.recommendations %}
            <div class="recommendations {{ r.condition.lower() }} {% if r.recommendations.urgency == 'high' %}urgent{% endif %}">
              <h4>{{ r.recommendations.title }}</h4>
              <ul>
                {% for tip in r.recommendations.tips %}
                <li>{{ tip }}</li>
                {% endfor %}
              </ul>
              <div class="action">{{ r.recommendations.action }}</div>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        {% endif %}
      </div>
      {% elif page == 'dataset' %}
      <div class="card upload-page">
        <h1>üìÇ Dataset Management</h1>
        <p>Manage training images for the PechayCNN model.</p>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ dataset_stats.total_images }}</div>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ dataset_stats.healthy_count }}</div>
                <div class="stat-label">Healthy Samples</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ dataset_stats.diseased_count }}</div>
                <div class="stat-label">Diseased Samples</div>
            </div>
        </div>

        <!-- Upload Form -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; margin-bottom: 30px;">
            <h3 style="color: #2e7d32; margin-top: 0;">üì§ Upload to Dataset</h3>
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="action" value="upload_dataset">
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Label:</label>
                    <select name="dataset_label" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                        <option value="Healthy">Healthy</option>
                        <option value="Diseased">Diseased</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Images:</label>
                    <input type="file" name="dataset_files" multiple accept="image/*" required>
                    <small style="color: #666;">You can select multiple files</small>
                </div>
                
                <button type="submit">Upload to Dataset</button>
            </form>
            {% if upload_status %}
            <div class="status-message" style="margin-top: 15px;">{{ upload_status }}</div>
            {% endif %}
        </div>

        <!-- Dataset Filter -->
        <div style="margin-bottom: 20px;">
            <span style="font-weight: bold; margin-right: 10px;">Filter by Label:</span>
            <a href="{{ url_for('dashboard', page='dataset') }}" class="date-filter-btn {{ 'active' if not request.args.get('label') else '' }}">All</a>
            <a href="{{ url_for('dashboard', page='dataset', label='Healthy') }}" class="date-filter-btn {{ 'active' if request.args.get('label') == 'Healthy' else '' }}">Healthy</a>
            <a href="{{ url_for('dashboard', page='dataset', label='Diseased') }}" class="date-filter-btn {{ 'active' if request.args.get('label') == 'Diseased' else '' }}">Diseased</a>
        </div>

        <!-- Image Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
            {% for img in dataset_images %}
            <div style="background: #fff; border: 1px solid #eee; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <img src="{{ url_for('uploaded_file', filename='dataset/' + img.label + '/' + img.filename) }}" 
                     alt="{{ img.label }}" 
                     style="width: 100%; height: 120px; object-fit: cover;"
                     onclick="window.open(this.src, '_blank')"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22120%22%3E%3Crect fill=%22%23eee%22 width=%22150%22 height=%22120%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23aaa%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                <div style="padding: 8px;">
                    <div class="{{ 'text-healthy' if img.label == 'Healthy' else 'text-diseased' }}">{{ img.label }}</div>
                    <div style="font-size: 0.7rem; color: #888; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">{{ img.filename }}</div>
                </div>
            </div>
            {% else %}
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #888;">
                No images found in dataset. Upload some images to get started.
            </div>
            {% endfor %}
        </div>
      </div>
      {% elif page == 'settings' %}
      <div class="card upload-page">
        <h1>‚öôÔ∏è Settings</h1>
        
        {% if settings_message %}
        <div class="status-message {{ 'error-message' if 'Error' in settings_message else '' }}" style="margin-bottom: 20px;">
          {{ settings_message }}
        </div>
        {% endif %}
        
        <div class="settings-grid">
          <!-- User Profile Section -->
          <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #e0e0e0;">
            <h2 style="color: #2e7d32; margin-top: 0; margin-bottom: 20px; font-size: 1.3rem;">üë§ Profile Settings</h2>
            
            <form method="POST" action="{{ url_for('dashboard', page='settings') }}">
              <input type="hidden" name="action" value="update_profile">
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">Username:</label>
                <input type="text" name="username" value="{{ current_user.username if current_user else session.user }}" 
                       style="width: 100%; padding: 12px; border: 2px solid #2e7d32; border-radius: 8px; font-size: 1rem;" 
                       required readonly>
                <small style="color: #777; font-size: 0.85rem;">Username cannot be changed</small>
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">Email:</label>
                <input type="email" name="email" value="{{ current_user.email if current_user else '' }}" 
                       style="width: 100%; padding: 12px; border: 2px solid #2e7d32; border-radius: 8px; font-size: 1rem;" 
                       required>
              </div>
              
              <button type="submit" style="width: 100%; background: #2e7d32; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s;">
                üíæ Update Profile
              </button>
            </form>
          </div>
          
          <!-- Change Password Section -->
          <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #e0e0e0;">
            <h2 style="color: #2e7d32; margin-top: 0; margin-bottom: 20px; font-size: 1.3rem;">üîí Change Password</h2>
            
            <form method="POST" action="{{ url_for('dashboard', page='settings') }}">
              <input type="hidden" name="action" value="change_password">
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">Current Password:</label>
                <input type="password" name="current_password" 
                       style="width: 100%; padding: 12px; border: 2px solid #2e7d32; border-radius: 8px; font-size: 1rem;" 
                       required>
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">New Password:</label>
                <input type="password" name="new_password" 
                       style="width: 100%; padding: 12px; border: 2px solid #2e7d32; border-radius: 8px; font-size: 1rem;" 
                       required minlength="4">
                <small style="color: #777; font-size: 0.85rem;">Minimum 4 characters</small>
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #555; font-weight: 600;">Confirm New Password:</label>
                <input type="password" name="confirm_password" 
                       style="width: 100%; padding: 12px; border: 2px solid #2e7d32; border-radius: 8px; font-size: 1rem;" 
                       required minlength="4">
              </div>
              
              <button type="submit" style="width: 100%; background: #17a2b8; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s;">
                üîë Change Password
              </button>
            </form>
          </div>
        </div>
        
        <!-- Account Information Section -->
        <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border: 2px solid #e0e0e0; margin-top: 30px;">
          <h2 style="color: #2e7d32; margin-top: 0; margin-bottom: 20px; font-size: 1.3rem;">üìä Account Information</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <p style="margin: 10px 0;"><strong>Account Created:</strong> {{ current_user.created_at[:10] if current_user and current_user.created_at else 'N/A' }}</p>
              <p style="margin: 10px 0;"><strong>Last Login:</strong> {{ current_user.last_login[:10] if current_user and current_user.last_login else 'N/A' }}</p>
            </div>
            <div>
              <p style="margin: 10px 0;"><strong>User ID:</strong> <code style="background: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;">{{ current_user.id[:8] if current_user and current_user.id else 'N/A' }}...</code></p>
              <p style="margin: 10px 0;"><strong>Account Status:</strong> <span style="color: #28a745; font-weight: 600;">‚úì Active</span></p>
            </div>
          </div>
        </div>
        
        <!-- System Information Section -->
        <div style="background: #fff3cd; padding: 25px; border-radius: 12px; border: 2px solid #ffc107; margin-top: 30px;">
          <h2 style="color: #856404; margin-top: 0; margin-bottom: 20px; font-size: 1.3rem;">üîß System Information</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <p style="margin: 10px 0;"><strong>Database:</strong> <span style="color: #28a745;">‚úì Supabase Connected</span></p>
              <p style="margin: 10px 0;"><strong>Database URL:</strong> <code style="background: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">{{ db_url_display if db_url_display else 'Configured' }}</code></p>
            </div>
            <div>
              <p style="margin: 10px 0;"><strong>Total Detections:</strong> {{ dashboard_stats.total_scans }}</p>
              <p style="margin: 10px 0;"><strong>App Version:</strong> 1.0.0</p>
            </div>
          </div>
        </div>
        
        <!-- Logout Section -->
        <div style="background: #fff3cd; padding: 25px; border-radius: 12px; border: 2px solid #ffc107; margin-top: 30px;">
          <h2 style="color: #856404; margin-top: 0; margin-bottom: 20px; font-size: 1.3rem;">üö™ Session Management</h2>
          
          <p style="color: #856404; margin-bottom: 15px;">Sign out of your account. You can log back in anytime.</p>
          
          <a href="{{ url_for('logout') }}" 
             style="display: inline-block; background: #ffc107; color: #856404; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s; text-decoration: none; border: 2px solid #ffc107;">
            üö™ Logout
          </a>
        </div>
      </div>
      {% endif %}
    </div>
    <footer>
      &copy; 2025 Pechay Detection System | Group 4 BSIT 4A
    </footer>
  </div>


  <script id="app-context" type="application/json">
    {
      "page": "{{ page }}"
    }
  </script>

  <script>
    let streamInterval = null;
    let cameraStreamImg = null;
    
    // Debug: Check if camera section is loaded (only for upload page)
    window.addEventListener('DOMContentLoaded', function() {
      // Get page from context
      let currentPage = 'unknown';
      try {
        const context = JSON.parse(document.getElementById('app-context').textContent);
        currentPage = context.page;
      } catch (e) {
        console.error('Failed to parse app context:', e);
      }

      if (currentPage === 'upload') {
        const cameraSection = document.getElementById('esp32CameraSection');
        const cameraIP = document.getElementById('cameraIP');
        
        console.log('=== Camera Section Debug ===');
        if (cameraSection) {
          console.log('‚úì Camera section found');
          cameraSection.style.display = 'block';
          cameraSection.style.visibility = 'visible';
        } else {
          console.error('‚úó Camera section NOT found!');
        }
        if (cameraIP) {
          console.log('‚úì Camera IP input found');
        } else {
          console.error('‚úó Camera IP input NOT found!');
        }
        console.log('===========================');
      }
    });
    
    function startStream() {
      const cameraIP = document.getElementById('cameraIP');
      if (!cameraIP) {
        alert('Camera IP input not found!');
        return;
      }
      const ipValue = cameraIP.value.trim();
      const statusDiv = document.getElementById('streamStatus');
      const streamImg = document.getElementById('cameraStream');
      const captureBtn = document.getElementById('captureBtn');
      const placeholder = document.getElementById('streamPlaceholder');
      
      if (!ipValue) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = 'Please enter ESP32-CAM IP address';
        }
        return;
      }
      
      stopStream();
      if (placeholder) placeholder.style.display = 'none';
      
      const streamUrl = 'http://' + ipValue + '/stream';
      streamImg.style.display = 'block';
      streamImg.style.width = '100%';
      streamImg.style.height = 'auto';
      cameraStreamImg = streamImg;
      
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Connecting to camera at ' + ipValue + '...';
      }
      
      const timestamp = new Date().getTime();
      streamImg.src = streamUrl + '?t=' + timestamp;
      
      streamImg.onload = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status connected';
          statusDiv.textContent = '‚úì Stream connected successfully!';
        }
        if (captureBtn) captureBtn.disabled = false;
        if (placeholder) placeholder.style.display = 'none';
      };
      
      streamImg.onerror = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Failed to connect. Check IP address and ensure ESP32-CAM is streaming.';
        }
        streamImg.style.display = 'none';
        if (captureBtn) captureBtn.disabled = true;
        if (placeholder) placeholder.style.display = 'block';
      };
    }
    
    function startPolling() {
      console.log('startPolling() called');
      const cameraIP = document.getElementById('cameraIP');
      if (!cameraIP) {
        alert('Camera IP input not found!');
        return;
      }
      const ipValue = cameraIP.value.trim();
      const statusDiv = document.getElementById('streamStatus');
      const streamImg = document.getElementById('cameraStream');
      const captureBtn = document.getElementById('captureBtn');
      const placeholder = document.getElementById('streamPlaceholder');
      
      if (!ipValue) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = 'Please enter ESP32-CAM IP address';
        }
        return;
      }
      
      stopStream();
      if (placeholder) placeholder.style.display = 'none';
      
      const captureUrl = 'http://' + ipValue + '/capture';
      streamImg.style.display = 'block';
      streamImg.style.width = '100%';
      streamImg.style.height = 'auto';
      cameraStreamImg = streamImg;
      
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Polling camera at ' + ipValue + '...';
      }
      if (captureBtn) captureBtn.disabled = false;
      
      streamInterval = setInterval(function() {
        const timestamp = new Date().getTime();
        streamImg.src = captureUrl + '?t=' + timestamp;
      }, 500);
      
      const timestamp = new Date().getTime();
      streamImg.src = captureUrl + '?t=' + timestamp;
      
      streamImg.onload = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status connected';
          statusDiv.textContent = '‚úì Polling active - Camera connected!';
        }
      };
      
      streamImg.onerror = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Failed to connect. Check IP address and ensure ESP32-CAM is running.';
        }
        stopStream();
      };
    }
    
    function stopStream() {
      const streamImg = document.getElementById('cameraStream');
      const streamFrame = document.getElementById('cameraStreamFrame');
      const statusDiv = document.getElementById('streamStatus');
      const captureBtn = document.getElementById('captureBtn');
      const placeholder = document.getElementById('streamPlaceholder');
      
      if (streamInterval) {
        clearInterval(streamInterval);
        streamInterval = null;
      }
      
      if (streamImg) {
        streamImg.src = '';
        streamImg.style.display = 'none';
      }
      if (streamFrame) {
        streamFrame.src = '';
        streamFrame.style.display = 'none';
      }
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Stream stopped';
      }
      if (captureBtn) captureBtn.disabled = true;
      cameraStreamImg = null;
      if (placeholder) placeholder.style.display = 'block';
    }
    
    function testConnection() {
      const cameraIP = document.getElementById('cameraIP');
      if (!cameraIP) return;
      const ipValue = cameraIP.value.trim();
      const statusDiv = document.getElementById('streamStatus');
      
      if (!ipValue) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = 'Please enter ESP32-CAM IP address';
        }
        return;
      }
      
      if (statusDiv) {
        statusDiv.className = 'stream-status';
        statusDiv.textContent = 'Testing connection to ' + ipValue + '...';
      }
      
      const testUrl = 'http://' + ipValue + '/capture';
      const img = new Image();
      
      img.onload = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status connected';
          statusDiv.textContent = '‚úì Camera is reachable! You can now start the stream.';
        }
      };
      
      img.onerror = function() {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Cannot reach camera at ' + ipValue + '. Check:\n- ESP32-CAM is powered on\n- Both devices are on same network\n- IP address is correct';
        }
      };
      
      const timestamp = new Date().getTime();
      img.src = testUrl + '?t=' + timestamp;
    }
    
    function captureFromStream() {
      const streamImg = document.getElementById('cameraStream');
      const canvas = document.getElementById('captureCanvas');
      const statusDiv = document.getElementById('streamStatus');
      
      if (!streamImg || !streamImg.src || streamImg.style.display === 'none') {
        alert('Please start the camera stream first');
        return;
      }
      
      try {
        canvas.width = streamImg.naturalWidth || streamImg.width || 640;
        canvas.height = streamImg.naturalHeight || streamImg.height || 480;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(streamImg, 0, 0, canvas.width, canvas.height);
        
        canvas.toBlob(function(blob) {
          const formData = new FormData();
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          formData.append('leafImage', blob, 'esp32_capture_' + timestamp + '.jpg');
          
          if (statusDiv) {
            statusDiv.className = 'stream-status';
            statusDiv.textContent = 'Uploading captured image...';
          }
          
          fetch(window.location.href, {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (response.ok) {
              if (statusDiv) {
                statusDiv.className = 'stream-status connected';
                statusDiv.textContent = '‚úì Image captured and uploaded successfully!';
              }
              setTimeout(function() {
                window.location.reload();
              }, 1500);
            } else {
              throw new Error('Upload failed');
            }
          })
          .catch(error => {
            if (statusDiv) {
              statusDiv.className = 'stream-status error';
              statusDiv.textContent = '‚úó Failed to upload image: ' + error.message;
            }
          });
        }, 'image/jpeg', 0.95);
      } catch (error) {
        if (statusDiv) {
          statusDiv.className = 'stream-status error';
          statusDiv.textContent = '‚úó Capture failed: ' + error.message;
        }
        console.error('Capture error:', error);
      }
    }
    
    window.addEventListener('beforeunload', function() {
      stopStream();
    });
  </script>

</body>
</html>


